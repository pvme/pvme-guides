- name: Scan files for emoji spacing violations
  id: grep
  env:
    GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  run: |
    echo "ðŸ”Ž Scanning files for bad emoji spacing..."
    branch_name="${GITHUB_HEAD_REF:-${GITHUB_REF##*/}}"
    bad=""

    dev_mode="false"  # Toggle true to scan entire branch, false for PR-changed files only

    echo "Dev mode: $dev_mode"

    if [ "$dev_mode" = true ]; then
      echo "ðŸš§ Dev mode ON â€” scanning all files in the branch..."
      mapfile -t files < <(git ls-tree -r --name-only HEAD)
    else
      echo "âœ… Standard mode â€” scanning changed files in PR..."
      pr_number="${{ github.event.pull_request.number }}"
      mapfile -t files < <(gh pr view "$pr_number" --json files -q '.files[].path')
    fi

    for file in "${files[@]}"; do
      echo "ðŸ“‚ Checking: $file"
      regex="[^[:space:]]<:.*?:[0-9]+>|<:.*?:[0-9]+>[^[:space:]]"
      matches=$(grep -nPo "$regex" "$file" || true)

      [ -z "$matches" ] && echo "âœ… No issues in $file" && continue

      file_block=""
      while IFS= read -r line; do
        lineno="${line%%:*}"                
        match="${line#*:}"                  
        [ -z "$match" ] && continue

        emoji=$(echo "$match" | grep -oP "<:.*?:\d+>")
        [ -z "$emoji" ] && continue

        escaped_emoji=$(printf '%s' "$emoji" | sed -e 's/[][(){}.^$*+?|\\]/\\&/g')

        # âœ… Skip match if preceded by allowed leading characters
        echo "$match" | perl -ne "exit 0 if /[rs_\"'\\(\\[{\-*]$escaped_emoji/; exit 1" && continue

        # âœ… Skip match if preceded by zero-width space
        echo "$match" | perl -ne "exit 0 if /\x{200B}$emoji/; exit 1" && continue

        # âœ… Skip match if inside backtick content
        full_line=$(sed "${lineno}q;d" "$file")
        export EMOJI="$emoji"
        if echo "$full_line" | perl -CS -ne '
          my $emoji = $ENV{"EMOJI"};
          while (m/`([^`]*)`/g) {
            exit 0 if index($1, $emoji) != -1;
          }
          exit 1;
        ' <<< ""; then continue; fi

        # âœ… Skip match if followed by allowed trailing characters
        echo "$match" | perl -ne "exit 0 if /^$escaped_emoji[.,!?;:\\\\)\\]{}_\"'\\-*]/; exit 1" && continue

        # ðŸš« Violation confirmed
        escaped_match=$(printf "%s" "$match" | sed 's/`/\\`/g')
        file_block+=$'\n'"* Line ${lineno}: \`${escaped_match}\`"
      done <<< "$matches"
      
      if [ -n "$file_block" ]; then
        file_url="https://github.com/${{ github.repository }}/blob/$branch_name/$file"
        bad+=$'\n'"**In [\`$file\`]($file_url):**"$'\n'"$file_block"
      fi
    done

    if [ -n "$bad" ]; then
      {
        echo "## âŒ Style Guide issue: Emoji Spacing"
        echo
        echo "Emojis must have a space before and after them unless surrounded by: \`r\`, \`s\`, \`_\`, punctuation, quotes, brackets, dashes, asterisks, backslashes, or a zero-width space."
        echo
        echo "_Tip: Cmd/Ctrl+Click file links to open them in a new tab._"
        echo
        echo "### __Offending Lines__"
        echo "$bad"
      } > emoji-comment.txt
      echo "found=true" >> "$GITHUB_OUTPUT"
    else
      echo "found=false" >> "$GITHUB_OUTPUT"
    fi
